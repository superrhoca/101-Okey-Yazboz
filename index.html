<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>101 Okey Yazboz OCR - Hesapla</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 12px; background:#fafafa; color:#111 }
    h1 { font-size:18px; margin:6px 0 12px }
    #controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
    button { padding:10px 12px; border-radius:6px; border: none; background:#1e88e5; color:white; font-weight:700 }
    button.secondary { background:#666 }
    #canvasWrap { position:relative; width:100%; max-width:760px; margin-bottom:8px; background:#222; }
    canvas { width:100%; height:auto; display:block; }
    .handle { position:absolute; top:6px; bottom:6px; width:10px; margin-left:-5px; background:rgba(255,100,0,0.85); border-radius:4px; touch-action:none; }
    .handle:active { background: rgba(255,60,0,1) }
    #status { margin:8px 0; color:#333 }
    .colResult { border:1px solid #ddd; padding:8px; border-radius:6px; background:white; margin-bottom:8px; }
    .colHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px }
    textarea { width:100%; min-height:64px; font-size:14px; padding:6px; border:1px solid #ccc; border-radius:6px; resize:vertical }
    table { width:100%; border-collapse:collapse; margin-top:8px }
    th, td { padding:6px 8px; border:1px solid #eee; text-align:center }
    .loser { color:#b71c1c; font-weight:800 }
    small { color:#666 }
    #tips { margin-top:8px; color:#444; font-size:13px }
    img.preview { width:100%; max-height:160px; object-fit:contain; border:1px solid #eee; margin-bottom:6px }
  </style>
  <!-- Tesseract.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.3/dist/tesseract.min.js"></script>
</head>
<body>
  <h1>101 Okey Yazboz — Kamera ile Oku ve Hesapla</h1>

  <div id="controls">
    <input id="file" type="file" accept="image/*" capture="environment" />
    <button id="resetBtn" class="secondary">Yeni Fotoğraf</button>
    <button id="ocrBtn">OCR & Hesapla</button>
    <button id="autoSplit" class="secondary">4 Eşit Sütun Yerleştir</button>
  </div>

  <div id="canvasWrap">
    <canvas id="c"></canvas>
    <!-- 4 draggable handles -->
    <div id="h0" class="handle" style="left:20%"></div>
    <div id="h1" class="handle" style="left:40%"></div>
    <div id="h2" class="handle" style="left:60%"></div>
    <div id="h3" class="handle" style="left:80%"></div>
  </div>

  <div id="status">Fotoğraf yükleyin veya çekin.</div>

  <div id="results"></div>

  <div id="tips">
    <strong>İpuçları:</strong>
    <ul>
      <li>İyi aydınlatma ve net odak (otomatik odaklama çalışsın).</li>
      <li>Kâğıdı kameraya mümkün olduğunca paralel tutun (çok eğik olursa perspektif hatası olur).</li>
      <li>El yazısı çok kötü ise manuel düzenleme yapabilirsiniz; OCR sonuçları düzenlenebilir.</li>
    </ul>
  </div>

<script>
(() => {
  const fileInput = document.getElementById('file');
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const wrap = document.getElementById('canvasWrap');
  const status = document.getElementById('status');
  const resultsDiv = document.getElementById('results');
  const ocrBtn = document.getElementById('ocrBtn');
  const resetBtn = document.getElementById('resetBtn');
  const autoSplit = document.getElementById('autoSplit');
  const handles = [document.getElementById('h0'), document.getElementById('h1'), document.getElementById('h2'), document.getElementById('h3')];

  let img = new Image();
  let naturalW = 0, naturalH = 0;
  let dragging = null;

  function setStatus(t) { status.textContent = t; }

  function drawImageToCanvas() {
    const maxWidth = Math.min(window.innerWidth - 24, 760);
    const scale = Math.min(maxWidth / naturalW, 1);
    canvas.width = Math.round(naturalW * scale);
    canvas.height = Math.round(naturalH * scale);
    canvas.style.width = canvas.width + 'px';
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    wrap.style.height = canvas.clientHeight + 'px';
    handles.forEach(h=>{
      if (!h.dataset.pos) return;
      h.style.left = (parseFloat(h.dataset.pos) * canvas.clientWidth) + 'px';
    });
  }

  function setDefaultHandles() {
    const w = canvas.clientWidth || 300;
    handles.forEach((h, i) => {
      const pos = (i+1) / (handles.length + 1);
      h.dataset.pos = pos;
      h.style.left = (pos * w) + 'px';
    });
  }

  fileInput.addEventListener('change', async (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    img = new Image();
    img.onload = () => {
      naturalW = img.width;
      naturalH = img.height;
      drawImageToCanvas();
      setDefaultHandles();
      setStatus('Fotoğraf yüklendi. Sütun sınırlarını ayarlayın, sonra "OCR & Hesapla"ya basın.');
    };
    img.src = url;
  });

  resetBtn.addEventListener('click', () => {
    ctx.clearRect(0,0,canvas.width, canvas.height);
    resultsDiv.innerHTML = '';
    fileInput.value = '';
    setStatus('Yeni fotoğraf seçin.');
  });

  autoSplit.addEventListener('click', () => {
    const w = canvas.clientWidth;
    handles.forEach((h, i) => {
      const pos = (i+1)/(handles.length+1);
      h.dataset.pos = pos;
      h.style.left = (pos * w) + 'px';
    });
  });

  handles.forEach(h => {
    h.addEventListener('pointerdown', (e) => {
      dragging = h;
      h.setPointerCapture(e.pointerId);
      e.preventDefault();
    });
    h.addEventListener('pointerup', (e) => { dragging = null; });
    h.addEventListener('pointercancel', (e) => { dragging = null; });
    h.addEventListener('pointermove', (e) => {
      if (!dragging) return;
      const rect = canvas.getBoundingClientRect();
      let x = e.clientX - rect.left;
      x = Math.max(4, Math.min(rect.width - 4, x));
      dragging.style.left = x + 'px';
      dragging.dataset.pos = (x / rect.width).toString();
    });
  });

  function cropColumnImage(colIndex) {
    const w = canvas.width;
    const h = canvas.height;
    const pos = handles.map(hh => parseFloat(hh.dataset.pos || 0.5));
    const sorted = [0, ...pos.slice(0).sort((a,b)=>a-b), 1];
    const left = Math.round(sorted[colIndex] * w);
    const right = Math.round(sorted[colIndex+1] * w);
    const cw = Math.max(1, right - left);
    const temp = document.createElement('canvas');
    temp.width = cw;
    temp.height = h;
    const tctx = temp.getContext('2d');
    tctx.drawImage(canvas, left, 0, cw, h, 0, 0, cw, h);
    return temp;
  }

  async function runOCRAndCalculate() {
    if (!canvas.width) { alert('Önce fotoğraf yükleyin.'); return; }
    setStatus('OCR çalışıyor — lütfen bekleyin (her sütun için kısa süre)...');
    resultsDiv.innerHTML = '';
    const colCount = handles.length + 1;
    const colData = [];

    for (let i=0;i<colCount;i++) {
      const temp = cropColumnImage(i);
      const blob = await new Promise(res => temp.toBlob(res, 'image/png'));
      const url = URL.createObjectURL(blob);
      const container = document.createElement('div');
      container.className = 'colResult';
      container.innerHTML = `<div class="colHeader"><strong>Sütun ${i+1}</strong><small>OCR sonuçlarını kontrol edip düzenleyebilirsiniz</small></div>
        <img src="${url}" class="preview" />
        <div style="margin-bottom:6px"><em>Tanıma sonucu (yükleniyor...)</em></div>
        <textarea data-col="${i}" ></textarea>`;
      resultsDiv.appendChild(container);

      try {
        const { data: { text } } = await Tesseract.recognize(blob, 'tur+eng', { logger: m => {}});
        const ta = container.querySelector('textarea');
        ta.value = text.trim();
        colData.push({ raw:text, textarea:ta });
      } catch (err) {
        const ta = container.querySelector('textarea');
        ta.value = '';
        colData.push({ raw:'', textarea:ta });
        console.error('OCR error col', i, err);
      }
    }

    function parseNumbersFromText(s) {
      const cleaned = s.replace(/[^\d\-\+\n\r,\. ]+/g, ' ');
      const matches = cleaned.match(/[-+]?\d+/g);
      if (!matches) return [];
      return matches.map(x => parseInt(x, 10));
    }

    const summary = [];
    for (let i=0;i<colData.length;i++) {
      const t = colData[i].textarea.value;
      const nums = parseNumbersFromText(t);
      const sum = nums.reduce((a,b)=>a+(isNaN(b)?0:b), 0);
      summary.push({index:i+1, numbers:nums, sum});
    }

    let maxSum = Math.max(...summary.map(s=>s.sum));
    if (!isFinite(maxSum)) maxSum = 0;
    const tbl = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>Sütun</th><th>Toplam</th><th>Sayılar (OCR ile bulunup düzenlenebilir)</th></tr>';
    tbl.appendChild(thead);
    const tbody = document.createElement('tbody');
    summary.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${s.index}</td><td class="${s.sum === maxSum && maxSum>0 ? 'loser' : ''}">${s.sum}</td><td>${s.numbers.join(', ')}</td>`;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    const title = document.createElement('div');
    title.style.marginTop = '8px';
    title.innerHTML = `<strong>Hesaplama Sonuçları</strong>`;
    resultsDiv.appendChild(title);
    resultsDiv.appendChild(tbl);

    setStatus('OCR tamamlandı. Sonuçları kontrol edip hatalı yerleri textareada düzeltin, sonra tekrar "OCR & Hesapla"ye basın.');
  }

  ocrBtn.addEventListener('click', runOCRAndCalculate);

  handles.forEach((h,i) => {
    if (!h.dataset.pos) h.dataset.pos = (i+1)/(handles.length+1);
  });

  window.addEventListener('resize', ()=>{
    if (img && img.src) drawImageToCanvas();
  });

  setStatus('Fotoğraf yükleyin veya çekin. Yükledikten sonra dikey çizgileri sütun sınırlarına getirip OCR & Hesapla\'ya basın.');
})();
</script>
</body>
</html>
